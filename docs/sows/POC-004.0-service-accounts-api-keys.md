# POC-004.0: Service Accounts and API Keys

**Status**: Validated
**Created**: 2025-01-28
**Validated**: 2026-01-28
**References**: DD-001 Bastion Architecture (Sections 2.1, 7.3)
**Dependencies**: POC-003.0 (Basic RBAC)

---

## 1. Objective

Implement non-human identity types for Bastion: service accounts for machine-to-machine authentication and API keys for external integrations. Prove that the identity model from DD-001 supports all three identity types using the same RBAC infrastructure.

---

## 2. Scope

### In Scope
- Service accounts table with client credentials (ID + secret)
- Service account authentication endpoint (client credentials flow)
- Service accounts receive JWT tokens (same as users)
- Service accounts use existing RBAC for authorization
- API keys table with key + hashed secret
- API key authentication via header (no token exchange)
- API keys have direct permission grants (no roles)
- API key creation shows secret once (never retrievable)
- Both identity types support tenant and platform scope
- Audit logging for all service account and API key operations

### Out of Scope
- mTLS authentication (production consideration)
- API key rate limiting (production consideration)
- API key IP restrictions (production consideration)
- Service account key rotation automation
- OAuth2 full implementation (only client credentials)
- API key usage analytics

---

## 3. Deliverables

### Directory Structure

```
poc/
├── internal/
│   ├── serviceaccount/
│   │   ├── handler.go           # Service account CRUD + auth
│   │   ├── service.go           # Business logic
│   │   └── repository.go        # DB operations
│   ├── apikey/
│   │   ├── handler.go           # API key CRUD
│   │   ├── service.go           # Business logic
│   │   ├── repository.go        # DB operations
│   │   └── middleware.go        # API key auth middleware
│   ├── auth/
│   │   └── middleware.go        # Updated: support multiple auth methods
│   └── server/
│       └── server.go            # Updated: register new routes
├── migrations/
│   └── 003_service_accounts_api_keys.sql
└── config.yaml
```

### Files to Create/Modify

#### 3.1 `poc/migrations/003_service_accounts_api_keys.sql`

Creates tables:
- `service_accounts`: id, name, description, client_id (unique), client_secret_hash, tenant_id (nullable), enabled, created_at, updated_at, last_used_at
- `api_keys`: id, name, description, key_prefix, key_hash, tenant_id (nullable), expires_at (nullable), enabled, created_at, last_used_at
- `api_key_permissions`: api_key_id, permission_id (junction table)

#### 3.2 `poc/internal/serviceaccount/repository.go`

- `Create(name, description, clientID, clientSecretHash, tenantID)` - Create service account
- `GetByID(id)` - Get by ID
- `GetByClientID(clientID)` - Get by client ID for auth
- `List(tenantID)` - List service accounts in tenant
- `Update(id, name, description, enabled)` - Update service account
- `Delete(id)` - Delete service account
- `UpdateLastUsed(id)` - Update last_used_at timestamp
- `RegenerateSecret(id, newSecretHash)` - Rotate secret

#### 3.3 `poc/internal/serviceaccount/service.go`

- `Create(name, description, tenantID)` - Generate client ID + secret, create account
- `Authenticate(clientID, clientSecret)` - Validate credentials, return JWT
- `List(tenantID)` - List service accounts
- `RegenerateSecret(id)` - Generate new secret, return it once
- `Enable(id)` / `Disable(id)` - Toggle enabled state

#### 3.4 `poc/internal/serviceaccount/handler.go`

HTTP handlers for:
- `POST /api/v1/service-accounts` - Create service account
- `GET /api/v1/service-accounts` - List service accounts
- `GET /api/v1/service-accounts/{id}` - Get service account details
- `PUT /api/v1/service-accounts/{id}` - Update service account
- `DELETE /api/v1/service-accounts/{id}` - Delete service account
- `POST /api/v1/service-accounts/{id}/regenerate-secret` - Rotate secret
- `POST /api/v1/auth/token` - Client credentials authentication

#### 3.5 `poc/internal/apikey/repository.go`

- `Create(name, description, keyPrefix, keyHash, tenantID, expiresAt)` - Create API key
- `GetByID(id)` - Get by ID
- `GetByPrefix(prefix)` - Get by key prefix for auth lookup
- `List(tenantID)` - List API keys in tenant
- `Delete(id)` - Delete API key
- `UpdateLastUsed(id)` - Update last_used_at
- `AddPermission(apiKeyID, permissionID)` - Grant permission
- `RemovePermission(apiKeyID, permissionID)` - Revoke permission
- `GetPermissions(apiKeyID)` - Get API key's permissions

#### 3.6 `poc/internal/apikey/service.go`

- `Create(name, description, tenantID, expiresAt, permissionIDs)` - Generate key, return it once
- `List(tenantID)` - List API keys (without secrets)
- `Delete(id)` - Delete API key
- `Authenticate(fullKey)` - Validate key, return API key record
- `CheckPermission(apiKeyID, resourceType, action)` - Check if key has permission

#### 3.7 `poc/internal/apikey/handler.go`

HTTP handlers for:
- `POST /api/v1/api-keys` - Create API key
- `GET /api/v1/api-keys` - List API keys
- `GET /api/v1/api-keys/{id}` - Get API key details
- `DELETE /api/v1/api-keys/{id}` - Delete API key
- `POST /api/v1/api-keys/{id}/permissions` - Add permission
- `DELETE /api/v1/api-keys/{id}/permissions/{permId}` - Remove permission

#### 3.8 `poc/internal/apikey/middleware.go`

- `AuthenticateAPIKey(service)` - Middleware to authenticate via X-API-Key header
- Sets apikey context if valid, passes through if header missing (allows fallback to JWT)

#### 3.9 Updates to Existing Files

**`poc/internal/auth/middleware.go`**:
- Update RequireAuth to check for API key context first, then JWT
- Support multiple authentication methods in chain

**`poc/internal/rbac/middleware.go`**:
- Update RequirePermission to work with API keys (direct permission check)
- Check identity type (user, service_account, api_key) and route accordingly

**`poc/internal/server/server.go`**:
- Register service account routes
- Register API key routes
- Add API key middleware to chain

---

## 4. Technical Approach

### 4.1 Service Account Authentication Flow

```
Client                                    Bastion
  │                                          │
  │ POST /api/v1/auth/token                  │
  │ grant_type=client_credentials            │
  │ client_id=sa_xxxxx                       │
  │ client_secret=xxxxx                      │
  │ ─────────────────────────────────────▶   │
  │                                          │
  │   1. Lookup service account by client_id │
  │   2. Verify client_secret (bcrypt)       │
  │   3. Check enabled=true                  │
  │   4. Generate JWT (identity_type=service)│
  │   5. Update last_used_at                 │
  │   6. Audit log                           │
  │                                          │
  │ ◀─────────────────────────────────────   │
  │ {"access_token":"eyJ...", "expires_in":900}
  │                                          │
  │ GET /api/v1/protected                    │
  │ Authorization: Bearer eyJ...             │
  │ ─────────────────────────────────────▶   │
  │                                          │
```

### 4.2 API Key Authentication Flow

```
Client                                    Bastion
  │                                          │
  │ GET /api/v1/protected                    │
  │ X-API-Key: bst_xxxx.secretpart           │
  │ ─────────────────────────────────────▶   │
  │                                          │
  │   1. Parse key (prefix.secret)           │
  │   2. Lookup by prefix                    │
  │   3. Verify secret hash                  │
  │   4. Check enabled=true, not expired     │
  │   5. Check api_key_permissions           │
  │   6. Update last_used_at                 │
  │   7. Audit log                           │
  │                                          │
  │ ◀─────────────────────────────────────   │
  │ Response                                 │
```

### 4.3 Identity Types in JWT

Service accounts receive JWTs with identity_type claim:

```json
{
  "sub": "service-account-uuid",
  "identity_type": "service_account",
  "name": "signal-smith-backend",
  "tenant_id": "tenant-uuid",
  "iat": 1706443800,
  "exp": 1706444700
}
```

Users have:
```json
{
  "sub": "user-uuid",
  "identity_type": "user",
  "email": "user@example.com",
  "tenant_id": "tenant-uuid"
}
```

### 4.4 Client ID and API Key Formats

**Service Account Client ID**: `sa_` + 20 random alphanumeric chars
- Example: `sa_Kj7mNp2xQr5sT8vW0yAb`

**Service Account Client Secret**: 40 random alphanumeric chars
- Example: `Xc3Df6Gh9Jk2Lm5Np8Qr1St4Vw7Yz0Ab3Ce6Fh9Jl`

**API Key Format**: `bst_` + 8 char prefix + `.` + 32 char secret
- Example: `bst_Ab3Ce6Fh.9Jk2Lm5Np8Qr1St4Vw7Yz0AbCdEfGhIj`
- Prefix stored in DB for lookup, full key hashed

### 4.5 Database Schema

```sql
-- Service Accounts
CREATE TABLE service_accounts (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    name VARCHAR(255) NOT NULL,
    description TEXT,
    client_id VARCHAR(50) UNIQUE NOT NULL,
    client_secret_hash TEXT NOT NULL,
    tenant_id UUID REFERENCES tenants(id) ON DELETE CASCADE,
    enabled BOOLEAN NOT NULL DEFAULT TRUE,
    created_at TIMESTAMP NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMP NOT NULL DEFAULT NOW(),
    last_used_at TIMESTAMP
);

-- API Keys
CREATE TABLE api_keys (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    name VARCHAR(255) NOT NULL,
    description TEXT,
    key_prefix VARCHAR(20) NOT NULL,
    key_hash TEXT NOT NULL,
    tenant_id UUID REFERENCES tenants(id) ON DELETE CASCADE,
    expires_at TIMESTAMP,
    enabled BOOLEAN NOT NULL DEFAULT TRUE,
    created_at TIMESTAMP NOT NULL DEFAULT NOW(),
    last_used_at TIMESTAMP
);

CREATE UNIQUE INDEX idx_api_keys_prefix ON api_keys(key_prefix);

-- API Key Permissions (direct grants, no roles)
CREATE TABLE api_key_permissions (
    api_key_id UUID NOT NULL REFERENCES api_keys(id) ON DELETE CASCADE,
    permission_id UUID NOT NULL REFERENCES permissions(id) ON DELETE CASCADE,
    PRIMARY KEY (api_key_id, permission_id)
);
```

### 4.6 Service Account RBAC

Service accounts use the same role system as users:
- Assigned roles via `user_roles` table (rename to `identity_roles` or use separate table)
- Same `RequirePermission` middleware works

For POC simplicity: Add service_account_id to user_roles as nullable column, or create separate `service_account_roles` table.

### 4.7 API Key Permissions

API keys have direct permission grants (no role indirection):
- Simpler model for integrations
- `api_key_permissions` links directly to `permissions` table
- Permission check is direct lookup, not role resolution

---

## 5. API Specification

### POST /api/v1/auth/token

Client credentials authentication for service accounts.

Request:
```
Content-Type: application/x-www-form-urlencoded

grant_type=client_credentials
client_id=sa_Kj7mNp2xQr5sT8vW0yAb
client_secret=Xc3Df6Gh9Jk2Lm5Np8Qr1St4Vw7Yz0Ab3Ce6Fh9Jl
```

Response (200):
```json
{
  "access_token": "eyJhbG...",
  "token_type": "Bearer",
  "expires_in": 900
}
```

Response (401):
```json
{
  "error": "invalid_client",
  "error_description": "invalid client credentials"
}
```

### POST /api/v1/service-accounts

Create a service account. Requires `bastion:service-account:create` permission.

Request:
```json
{
  "name": "signal-smith-backend",
  "description": "Backend service for Signal Smith",
  "tenant_id": "tenant-uuid",
  "role_ids": ["role-uuid-1", "role-uuid-2"]
}
```

Response (201):
```json
{
  "id": "uuid",
  "name": "signal-smith-backend",
  "client_id": "sa_Kj7mNp2xQr5sT8vW0yAb",
  "client_secret": "Xc3Df6Gh9Jk2Lm5Np8Qr1St4Vw7Yz0Ab3Ce6Fh9Jl",
  "tenant_id": "tenant-uuid",
  "created_at": "2025-01-28T..."
}
```

Note: `client_secret` is only returned on creation. Store it securely.

### GET /api/v1/service-accounts

List service accounts. Returns accounts in caller's tenant (or all for platform admin).

Response (200):
```json
{
  "service_accounts": [
    {
      "id": "uuid",
      "name": "signal-smith-backend",
      "client_id": "sa_Kj7mNp2xQr5sT8vW0yAb",
      "tenant_id": "tenant-uuid",
      "enabled": true,
      "last_used_at": "2025-01-28T...",
      "created_at": "2025-01-28T..."
    }
  ]
}
```

### POST /api/v1/service-accounts/{id}/regenerate-secret

Regenerate client secret. Returns new secret once.

Response (200):
```json
{
  "client_id": "sa_Kj7mNp2xQr5sT8vW0yAb",
  "client_secret": "NewSecret123..."
}
```

### POST /api/v1/api-keys

Create an API key. Requires `bastion:api-key:create` permission.

Request:
```json
{
  "name": "external-dashboard",
  "description": "Read-only access for monitoring dashboard",
  "tenant_id": "tenant-uuid",
  "expires_at": "2025-12-31T23:59:59Z",
  "permission_ids": ["perm-uuid-1", "perm-uuid-2"]
}
```

Response (201):
```json
{
  "id": "uuid",
  "name": "external-dashboard",
  "api_key": "bst_Ab3Ce6Fh.9Jk2Lm5Np8Qr1St4Vw7Yz0AbCdEfGhIj",
  "tenant_id": "tenant-uuid",
  "expires_at": "2025-12-31T23:59:59Z",
  "created_at": "2025-01-28T..."
}
```

Note: `api_key` is only returned on creation. Store it securely.

### GET /api/v1/api-keys

List API keys.

Response (200):
```json
{
  "api_keys": [
    {
      "id": "uuid",
      "name": "external-dashboard",
      "key_prefix": "bst_Ab3Ce6Fh",
      "tenant_id": "tenant-uuid",
      "expires_at": "2025-12-31T23:59:59Z",
      "enabled": true,
      "last_used_at": "2025-01-28T...",
      "created_at": "2025-01-28T..."
    }
  ]
}
```

### Using API Key Authentication

Include the full API key in the `X-API-Key` header:

```
GET /api/v1/protected-resource
X-API-Key: bst_Ab3Ce6Fh.9Jk2Lm5Np8Qr1St4Vw7Yz0AbCdEfGhIj
```

---

## 6. Success Criteria

1. Service account can be created with auto-generated credentials
2. Service account can authenticate via client credentials and receive JWT
3. Service account JWT works with existing protected endpoints
4. Service account can be assigned roles and permissions are enforced
5. API key can be created with specific permissions
6. API key authenticates via X-API-Key header
7. API key permissions are checked on protected endpoints
8. Expired API keys are rejected
9. Disabled service accounts and API keys are rejected
10. Secret shown only once at creation
11. Secret regeneration works for service accounts
12. Audit log records all authentication and CRUD operations

---

## 7. Validation Steps

```bash
# 1. Apply migration
docker exec -i bastion-db psql -U bastion -d bastion_poc \
  < poc/migrations/003_service_accounts_api_keys.sql

# 2. Start server
cd poc && go run ./cmd/bastion -config config.yaml

# 3. Create service account (as admin)
curl -X POST http://localhost:8081/api/v1/service-accounts \
  -H "Authorization: Bearer $ADMIN_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"name":"test-service","description":"Test service account"}'

# Save client_id and client_secret from response

# 4. Authenticate as service account
curl -X POST http://localhost:8081/api/v1/auth/token \
  -H "Content-Type: application/x-www-form-urlencoded" \
  -d "grant_type=client_credentials&client_id=$CLIENT_ID&client_secret=$CLIENT_SECRET"

# Save access_token from response

# 5. Use service account token
curl http://localhost:8081/api/v1/users/me \
  -H "Authorization: Bearer $SA_TOKEN"

# 6. Create API key (as admin)
curl -X POST http://localhost:8081/api/v1/api-keys \
  -H "Authorization: Bearer $ADMIN_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"name":"test-key","description":"Test API key","permission_ids":["perm-id"]}'

# Save api_key from response

# 7. Use API key
curl http://localhost:8081/api/v1/health \
  -H "X-API-Key: $API_KEY"

# 8. Test permission enforcement with API key
curl http://localhost:8081/api/v1/tenants \
  -H "X-API-Key: $API_KEY"
# Should return 403 if API key lacks tenant:read permission

# 9. Disable and test rejection
# (disable via API, then retry auth - should fail)

# 10. Check audit log
docker exec bastion-db psql -U bastion -d bastion_poc \
  -c "SELECT event_type, created_at FROM audit_log ORDER BY created_at DESC LIMIT 10;"
```

---

## 8. New Permissions

Add to seed data:

```sql
-- Service account permissions
INSERT INTO permissions (resource_type, action, description) VALUES
('bastion:service-account', 'create', 'Create service accounts'),
('bastion:service-account', 'read', 'View service account details'),
('bastion:service-account', 'update', 'Modify service accounts'),
('bastion:service-account', 'delete', 'Delete service accounts');

-- API key permissions
INSERT INTO permissions (resource_type, action, description) VALUES
('bastion:api-key', 'create', 'Create API keys'),
('bastion:api-key', 'read', 'View API key details'),
('bastion:api-key', 'delete', 'Delete API keys');
```

---

## 9. Notes

- Service accounts use same role-based RBAC as users
- API keys use direct permission grants (simpler model)
- Both support platform-level (null tenant_id) and tenant-scoped
- Secrets are bcrypt hashed, never stored plaintext
- API key prefix enables efficient lookup without exposing full key
- No refresh tokens for service accounts (just re-authenticate)
- No rate limiting for POC (production consideration)
- Consider key rotation policies for production

---

## Approval

- [x] SOW Reviewed
- [x] SOW Approved

**Approved By**: User
**Date**: 2025-01-28
