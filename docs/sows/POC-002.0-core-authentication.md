# POC-002.0: Core Authentication

**Status**: Proposed
**Created**: 2025-01-28
**References**: DD-001 Bastion Architecture (Section 9.1)

---

## 1. Objective

Implement core authentication for the Bastion POC: user creation, login with password, JWT-based access/refresh tokens, session management, and basic audit logging.

---

## 2. Scope

### In Scope
- PostgreSQL database connection
- User creation with bcrypt password hashing
- Login endpoint returning access + refresh tokens
- Token refresh endpoint
- Logout endpoint (session invalidation)
- Token validation middleware
- Session tracking with activity timestamps
- Basic audit log table

### Out of Scope
- MFA, SSO, federation (future)
- Service accounts (POC-004+)
- API keys (POC-004+)
- Tenant isolation (POC-003 will add tenant context)
- Password reset flow
- Email verification
- Rate limiting

---

## 3. Deliverables

### Directory Structure

```
poc/
├── cmd/bastion/
│   └── main.go                    # Updated: add DB connection
├── internal/
│   ├── server/
│   │   └── server.go              # Updated: register auth routes
│   ├── config/
│   │   └── config.go              # Configuration loading
│   ├── database/
│   │   └── database.go            # PostgreSQL connection
│   ├── auth/
│   │   ├── handler.go             # HTTP handlers
│   │   ├── service.go             # Business logic
│   │   ├── tokens.go              # JWT generation/validation
│   │   └── middleware.go          # Auth middleware
│   ├── user/
│   │   ├── handler.go             # User CRUD handlers
│   │   ├── service.go             # User business logic
│   │   └── repository.go          # Database operations
│   └── audit/
│       └── audit.go               # Simple audit logging
├── migrations/
│   └── 001_initial_schema.sql     # Database schema
├── config.yaml                    # Default configuration
└── go.mod                         # Updated dependencies
```

### Files to Create/Modify

#### 3.1 `poc/config.yaml`

```yaml
server:
  port: 8080

database:
  host: localhost
  port: 5432
  name: bastion_poc
  user: bastion
  password: bastion_dev
  sslmode: disable

auth:
  access_token_ttl: 15m
  refresh_token_ttl: 24h
  jwt_secret: change-me-in-production
```

#### 3.2 `poc/migrations/001_initial_schema.sql`

Creates tables:
- `users`: id, email, password_hash, created_at, updated_at
- `sessions`: id, user_id, refresh_token_hash, created_at, last_activity, expires_at, revoked
- `audit_log`: id, event_type, user_id, details, ip_address, created_at

#### 3.3 `poc/internal/config/config.go`

Loads YAML configuration into struct. Uses gopkg.in/yaml.v3.

#### 3.4 `poc/internal/database/database.go`

- `Connect(cfg)` - Returns *sql.DB connection
- Basic connection validation

#### 3.5 `poc/internal/auth/tokens.go`

- `GenerateAccessToken(userID, email)` - Returns signed JWT (15 min TTL)
- `GenerateRefreshToken()` - Returns random token string
- `ValidateAccessToken(tokenString)` - Returns claims or error

#### 3.6 `poc/internal/auth/service.go`

- `Login(email, password)` - Validates credentials, creates session, returns tokens
- `Refresh(refreshToken)` - Validates refresh token, issues new access token, updates activity
- `Logout(sessionID)` - Revokes session

#### 3.7 `poc/internal/auth/handler.go`

HTTP handlers for:
- `POST /api/v1/auth/login` - Login
- `POST /api/v1/auth/refresh` - Refresh token
- `POST /api/v1/auth/logout` - Logout (requires auth)

#### 3.8 `poc/internal/auth/middleware.go`

- `RequireAuth` - Middleware that validates JWT and adds user context

#### 3.9 `poc/internal/user/repository.go`

- `Create(email, passwordHash)` - Insert user
- `GetByEmail(email)` - Lookup for login
- `GetByID(id)` - Lookup by ID

#### 3.10 `poc/internal/user/service.go`

- `CreateUser(email, password)` - Hash password, call repository

#### 3.11 `poc/internal/user/handler.go`

- `POST /api/v1/users` - Create user (no auth required for POC)
- `GET /api/v1/users/me` - Get current user (requires auth)

#### 3.12 `poc/internal/audit/audit.go`

- `Log(eventType, userID, details, ip)` - Insert audit record

---

## 4. Technical Approach

### 4.1 Dependencies (to add)

```
github.com/golang-jwt/jwt/v5    # JWT tokens
github.com/lib/pq               # PostgreSQL driver
golang.org/x/crypto             # bcrypt
gopkg.in/yaml.v3                # Config (already approved)
```

### 4.2 Token Flow

```
Login:
  1. Validate email/password
  2. Create session record
  3. Generate access token (JWT, 15 min)
  4. Generate refresh token (random, stored hashed)
  5. Return both tokens
  6. Audit log: login_success or login_failure

Refresh:
  1. Validate refresh token against stored hash
  2. Check session not revoked, not expired
  3. Update last_activity timestamp
  4. Generate new access token
  5. Return new access token
  6. Audit log: token_refresh

Logout:
  1. Mark session as revoked
  2. Audit log: logout
```

### 4.3 JWT Claims

```json
{
  "sub": "user-uuid",
  "email": "user@example.com",
  "iat": 1706443800,
  "exp": 1706444700
}
```

### 4.4 Password Hashing

bcrypt with default cost (10). Simple and secure.

### 4.5 Database Setup

Manual for POC:
```bash
createdb bastion_poc
psql bastion_poc < migrations/001_initial_schema.sql
```

---

## 5. API Specification

### POST /api/v1/auth/login

Request:
```json
{
  "email": "user@example.com",
  "password": "secret123"
}
```

Response (200):
```json
{
  "access_token": "eyJhbG...",
  "refresh_token": "abc123...",
  "expires_in": 900
}
```

Response (401):
```json
{
  "error": "invalid credentials"
}
```

### POST /api/v1/auth/refresh

Request:
```json
{
  "refresh_token": "abc123..."
}
```

Response (200):
```json
{
  "access_token": "eyJhbG...",
  "expires_in": 900
}
```

### POST /api/v1/auth/logout

Headers: `Authorization: Bearer <access_token>`

Response (204): No content

### POST /api/v1/users

Request:
```json
{
  "email": "user@example.com",
  "password": "secret123"
}
```

Response (201):
```json
{
  "id": "uuid",
  "email": "user@example.com",
  "created_at": "2025-01-28T..."
}
```

### GET /api/v1/users/me

Headers: `Authorization: Bearer <access_token>`

Response (200):
```json
{
  "id": "uuid",
  "email": "user@example.com",
  "created_at": "2025-01-28T..."
}
```

---

## 6. Success Criteria

1. User can be created via API
2. User can login and receive access + refresh tokens
3. Access token validates correctly in middleware
4. Refresh token issues new access token
5. Logout revokes session
6. Subsequent refresh with revoked session fails
7. Audit log contains login, refresh, logout events
8. Invalid credentials return 401

---

## 7. Dependencies

- POC-001.0: Basic Go structure (completed)

---

## 8. Validation Steps

```bash
# Start PostgreSQL (Docker or local)
docker run -d --name bastion-db \
  -e POSTGRES_USER=bastion \
  -e POSTGRES_PASSWORD=bastion_dev \
  -e POSTGRES_DB=bastion_poc \
  -p 5432:5432 \
  postgres:15

# Apply migrations
psql postgresql://bastion:bastion_dev@localhost/bastion_poc \
  < poc/migrations/001_initial_schema.sql

# Start server
cd poc && go run ./cmd/bastion

# Create user
curl -X POST http://localhost:8080/api/v1/users \
  -H "Content-Type: application/json" \
  -d '{"email":"test@example.com","password":"secret123"}'

# Login
curl -X POST http://localhost:8080/api/v1/auth/login \
  -H "Content-Type: application/json" \
  -d '{"email":"test@example.com","password":"secret123"}'

# Use access token
curl http://localhost:8080/api/v1/users/me \
  -H "Authorization: Bearer <access_token>"

# Refresh
curl -X POST http://localhost:8080/api/v1/auth/refresh \
  -H "Content-Type: application/json" \
  -d '{"refresh_token":"<refresh_token>"}'

# Logout
curl -X POST http://localhost:8080/api/v1/auth/logout \
  -H "Authorization: Bearer <access_token>"
```

---

## 9. Notes

- JWT secret is hardcoded in config for POC; production would use secrets management
- No password complexity validation for POC
- No email validation for POC
- Single-tenant for now; POC-003 adds tenant context
- Session absolute max timeout deferred to POC-003 (requires more session management)

---

## Approval

- [x] SOW Reviewed
- [x] SOW Approved

**Approved By**: User
**Date**: 2025-01-28
